name: MacOS
on:
  push:
    branches: [ main ]
    tags:
      - 'v*'
      - '*.*.*'
  pull_request:
    branches: [ main ]
permissions:
  contents: write
jobs:
  build:
    runs-on: macos-latest
    steps:
    - name: Checkout Bobcat repository
      uses: actions/checkout@v4
      with:
        path: Bobcat
        fetch-depth: 0

    - name: Install dependencies
      run: |
        brew update
        brew install create-dmg dylibbundler

    - name: Checkout U++ repository
      uses: actions/checkout@v4
      with:
        repository: ultimatepp/ultimatepp
        ref: v2025.1.1
        path: upp-source

    - name: Configure and build U++ from the master branch
      working-directory: upp-source
      run: |
        ./configure
        make -f ./umkMakefile -j 4

    - name: Build Bobcat
      working-directory: Bobcat
      run: ../upp-source/umk ./,../upp-source/uppsrc Bobcat CLANG.bm -brh +GUI,SHARED Bobcat

    - name: Get the version
      if: startsWith(github.ref, 'refs/tags/')
      run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_ENV
      shell: bash

    - name: Copy icon into .app bundle
      if: startsWith(github.ref, 'refs/tags/')
      run: |
        mkdir -p bobcat.iconset
        sips -z 16 16     Bobcat/Bobcat/data/bobcat128x128.png --out bobcat.iconset/icon_16x16.png
        sips -z 32 32     Bobcat/Bobcat/data/bobcat128x128.png --out bobcat.iconset/icon_16x16@2x.png
        sips -z 32 32     Bobcat/Bobcat/data/bobcat128x128.png --out bobcat.iconset/icon_32x32.png
        sips -z 64 64     Bobcat/Bobcat/data/bobcat128x128.png --out bobcat.iconset/icon_32x32@2x.png
        sips -z 128 128   Bobcat/Bobcat/data/bobcat128x128.png --out bobcat.iconset/icon_128x128.png
        sips -z 256 256   Bobcat/Bobcat/data/bobcat128x128.png --out bobcat.iconset/icon_128x128@2x.png
        sips -z 256 256   Bobcat/Bobcat/data/bobcat128x128.png --out bobcat.iconset/icon_256x256.png
        sips -z 512 512   Bobcat/Bobcat/data/bobcat128x128.png --out bobcat.iconset/icon_256x256@2x.png
        sips -z 512 512   Bobcat/Bobcat/data/bobcat128x128.png --out bobcat.iconset/icon_512x512.png
        iconutil -c icns bobcat.iconset -o Bobcat/Bobcat/Bobcat.app/Contents/Resources/bobcat.icns

    - name: Update Info.plist with version and icon
      if: startsWith(github.ref, 'refs/tags/')
      run: |
        cat <<EOF > Bobcat/Bobcat/Bobcat.app/Contents/Info.plist
        <?xml version="1.0" encoding="UTF-8"?>
        <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN"
          "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
        <plist version="1.0">
        <dict>
          <key>CFBundleName</key>
          <string>Bobcat</string>
          <key>CFBundleDisplayName</key>
          <string>Bobcat</string>
          <key>CFBundleIdentifier</key>
          <string>com.iylmz.bobcat</string>
          <key>CFBundleVersion</key>
          <string>${{ env.VERSION }}</string>
          <key>CFBundleShortVersionString</key>
          <string>${{ env.VERSION }}</string>
          <key>CFBundleExecutable</key>
          <string>Bobcat</string>
          <key>CFBundleIconFile</key>
          <string>bobcat</string>
          <key>CFBundlePackageType</key>
          <string>APPL</string>
          <key>NSHighResolutionCapable</key>
          <true/>
          <key>LSMinimumSystemVersion</key>
          <string>11.0</string>
        </dict>
        </plist>
        EOF

    - name: Bundle shared libraries with dylibbundler
      if: startsWith(github.ref, 'refs/tags/')
      run: |
        dylibbundler -od -b \
          -x Bobcat/Bobcat/Bobcat.app/Contents/MacOS/Bobcat \
          -d Bobcat/Bobcat/Bobcat.app/Contents/libs \
          -p @executable_path/../libs

    - name: Create DMG
      if: startsWith(github.ref, 'refs/tags/')
      run: |
        create-dmg \
          --volname "Bobcat ${{ env.VERSION }}" \
          --volicon "Bobcat/Bobcat/Bobcat.app/Contents/Resources/bobcat.icns" \
          --window-pos 200 120 \
          --window-size 600 400 \
          --icon-size 100 \
          --icon "Bobcat.app" 175 190 \
          --hide-extension "Bobcat.app" \
          --app-drop-link 425 190 \
          "bobcat-terminal_${{ env.VERSION }}_macos.dmg" \
          "Bobcat/Bobcat/Bobcat.app"

    - name: Upload DMG as artifact
      if: startsWith(github.ref, 'refs/tags/')
      uses: actions/upload-artifact@v4
      with:
        name: bobcat-terminal_${{ env.VERSION }}_macos
        path: bobcat-terminal_${{ env.VERSION }}_macos.dmg

    - name: Create GitHub release & upload asset
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ env.VERSION }}
        name: Release ${{ env.VERSION }}
        draft: false
        prerelease: false
        files: |
          bobcat-terminal_${{ env.VERSION }}_macos.dmg
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}